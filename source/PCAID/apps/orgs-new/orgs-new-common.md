---
sidebar_position: 1
---

# 組織作成 - 共通

## 全体動作（機能）

### 組織作成フローの開始

- URLのクエリーパラメーターとして「受付セッションID」を指定することで組織の作成フローを開始する
  - 呼び出し元は、事前に組織の初期情報を登録して受付セッションIDを発行しておく
  - 組織作成フローは、受付セッションIDにより参照できる組織の初期情報を使用する
  - 例：https://{pcaid-domain}/orgs-new?receipt_session_id=xxxx-xxx-xxx-xxxx
- 組織で利用する契約済みのサービスを選択する
- 組織の作成と同時に、初回の組織管理者となる [PCAアカウント](/docs/common/PCAアカウント.md) を決定する

### 受付セッションID

- [組織作成準備 POST organizations/prepare](/docs/api/organizations/prepare/POST%20組織作成準備.md) で初期情報を登録して、受付セッションIDを受け取る
- 受付セッションIDは、[OTP認証](/docs/common-dev/otp-authentication.md) を起点とした一時的なセッションであり、有効期限は **60分** とする
  - セッション期限が切れたら、組織作成フローは最初からやり直しとなる
- 初期情報には、クライアントIDと、組織作成フローにおける入力データの初期値が含まれる

### 組織作成の回復措置

組織作成後の回復措置として以下のケースを想定して対応方法を用意する

- 招待メールの再送信
- 招待メールの期限切れ（１週間）
- メールアドレス間違いによるメール不達
- 他人メールアドレスによる誤送信

上記のケースに対処するため、以下の仕様で組織作成をやり直せるようにする

- 作成時に指定する利用サービス（サービス区画）だけを持つ組織を対象とする
  - 複数の利用サービス（サービス区画）がある状況なら、ユーザー運用が軌道に乗っていると考える
  - 組織管理者の権限を付与すべきでない状況になっている可能性がある
- 組織情報や管理者情報は、繰り返し作成可能にする（冪等にする）
  - 作成済み組織情報があれば初期値とし、作成時は内部的にデータを更新する
    - 利用サービスや組織名は繰り返しても変わらないので、変更できるのは組織表示名のみ
  - 組織管理者は常に新規作成として入力するが、作成時は内部的にデータを挿入または更新する
    - 既存ユーザーはメールアドレスで特定する
      - 組織内の作成済みユーザーであればユーザー情報を更新する
        - ユーザー名、姓名・カナ
        - ログイン名が不一致ならエラーとする
      - 別組織の作成済みユーザーであればユーザー情報を維持する
        - ログイン名は新しい組織用に追加となる
      - 一般ユーザーであれば組織管理者の権限を付与する（昇格させる）
    - 二人目以降の組織管理者を作成できる
    - ログイン名の重複はエラーとする
- 入力した組織管理者に対しては、常に招待メールを送信する
  - 新規組織のみ所属であれば、アカウント設定リクエストを送信する
    - 新規組織に作成済みユーザーであっても同様とする
  - 他組織に所属済みであれば、メールアドレス確認リクエストを送信する

### 実行権限

- 受付セッションIDの発行には、内部的に [OTP認証](/docs/common-dev/otp-authentication.md) を必要とする
  - 呼び出し元のシステムは、実行手順を把握している必要があり、管理者が実行することを想定する
- [OTP認証](/docs/common-dev/otp-authentication.md) のワンタイムパスワードを生成するには、クライアントとサーバー間で、事前にソルト値（salt）を共有しておく必要がある
  - 組織作成の実行を認めたサービス（システム）に対してのみ、ソルト値を共有する想定とする
- サーバーは、クライアントごとに異なるソルト値を共有できる
  - ソルト値はローテーションできる
  - 新しいソルト値を共有して、古いソルト値を順次破棄できる
