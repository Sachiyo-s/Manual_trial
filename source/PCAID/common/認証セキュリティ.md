---
sidebar_position: 22
---

# 22. 認証セキュリティ

## 認証レベル

| 強度の種類 | 適用レベル | PCA IDにおける対応内容 |
| --- | --- | --- |
| 身元確認 <br/>（IAL） | Level1 | - 申し込み情報に基づき、PCAが身元チェックし、組織および管理者のIDを発行する <br/> - 組織IDを発行された管理者が利用ユーザーのIDを登録する <br/> - ユーザーの本人確認はメール到達確認の自己表明とする |
| ユーザー認証 <br/>（AAL） | Level2 or 3 | - パスキー認証 <br/> - ２段階認証 <br/> 　- パスワードとメール認証 <br/>　- パスワードとバックアップコード認証（緊急時のリカバリー手段） |
| 認証連携 <br/>（FAL） | Level2 | OpenID Connect / SAML によるID連携に対応する |

### 関連情報

- [ユーザー認証](./ユーザー認証.md)

## パスワードポリシー

- 12～127文字
- 文字種類による組み合わせは求めない
  - ブラウザーのパスワード機能やパスワード管理ツールとの親和性を重視する
- パスワード世代管理：1世代（変更時、新旧で同じパスワードは不可）
- メールアドレスと同じパスワードは不可
- 再認証せずにパスワードを変更できる最大時間：5分
- OWASPも参考にする[1,000,000件辞書](https://github.com/danielmiessler/SecLists/blob/master/Passwords/xato-net-10-million-passwords-100000.txt)に含まれるパスワードは不可
  - 12文字以上の46,296件を抽出して利用する
  - [xato-net-10-million-passwords-1000000-12char+.txt](./materials/xato-net-10-million-passwords-1000000-12char+.txt)
- アルゴリズム: [PBKDF2 (sha256)](https://ja.wikipedia.org/wiki/PBKDF2)
  - ソルト：16バイト（128ビット）
    - 暗号用乱数をアカウント別に使用する
  - ストレッチング回数：100,000回

### OWASP ASVS 4.0 Authentication

- 2.1.1 ユーザー・セット・パスワードの長さが少なくとも12文字（複数のスペースを合わせた後）であることを確認する。
- 2.1.2 少なくとも64文字のパスワードが許可され、128文字以上のパスワードは拒否されることを確認する。
- 2.1.3 パスワードの切り捨てが行われないことを確認する。ただし、連続した複数の空白は1つの空白に置き換えることができる。
- 2.1.4 スペースや絵文字のような言語的に中立な文字を含む、印刷可能なユニコード文字がパスワードで許可されていることを確認する。
- 2.1.5 ユーザーがパスワードを変更できることを確認する。
- 2.1.6 パスワード変更機能がユーザーの現在のパスワードと新しいパスワードを要求することを確認する。
- 2.1.7 パスワードが、破壊されたパスワードのセットと照合されることを確認する（シス テムのパスワード・ポリシーに一致する、最も一般的なパスワードの上位 1,000 件または 10,000 件など）。
- 2.1.8 ユーザーがより強力なパスワードを設定できるよう、パスワード強度計が提供されていることを確認する。
- 2.1.9 許可される文字の種類を制限するパスワード構成規則がないことを確認する。大文字、小文字、数字、特殊文字は必要ありません。
- 2.1.10 定期的なクレデンシャルのローテーションまたはパスワード履歴要件がないことを確認する。
- 2.1.11「貼り付け」機能、ブラウザのパスワードヘルパー、外部のパスワードマネージャーが許可されていることを確認する。
- 2.1.12 ビルトイン機能がないプラットフォームでは、マスクされたパスワード全体を一時的に表示するか、パスワードの最後に入力された文字を一時的に表示するかを、ユーザーが選択できることを確認する。
- 2.4.1 パスワードがオフライン攻撃に耐性のある形式で保存されていることを検証すること。パスワードは、承認された一方向性鍵導出またはパスワード・ハッシュ関数を使用して、塩付けおよびハッシュ化しなければならない（SHALL）。鍵導出およびパスワード・ハッシュ関数は、パスワード・ハッシュを生成する際、パスワード、ソルト、およびコスト係数を入力とする。
- 2.4.2 ソルトは少なくとも32ビット長であり、格納されたハッシュ間のソルト値の衝突を最小化するように任意に選択されることを確認する。各クレデンシャルについて、一意のソルト値と結果のハッシュを格納しなければならない（SHALL）。
- 2.4.3 PBKDF2が使用される場合、反復回数は検証サーバーの性能が許す限り大きくすべきであり、通常は少なくとも100,000回反復すべきであることを検証する。

### [CIS Benchmarksが推奨するパスワードポリシー](https://note.com/it_catto/n/n867233f1a6c5)

#### 5.1.1 Password Length (Min)

- パスワード認証のみの場合は14文字以上
- MFA（多要素認証）がある場合は8文字以上
- 最大文字数についてはシステム制約上で制限なし

> 一般的により長いパスワードはより安全で（クラッキングが難しい）。  
> しかし、**強制されたパスワードの長さの要件は予測可能で望ましくないユーザー行動を引き起こす可能性もあります**。  
> 例えば、ユーザーに最低16文字のパスワードを要求することは、4文字の繰り返しパターン（"fourfourfourfour"）や、"passwordpassword"のような簡単に推測できるパスワードを選択させる可能性があります。  
> また、**長さの要件は、ユーザーが他の安全でない方法をとる可能性を高めます**。  
> 例えば、パスワードを書き留めたり、再利用したり、暗号化されていないままドキュメントに保存したりすることです。  
> **合理的な最小の長さの要件を設定**し、最大文字数の制限を設けないことで、使用される平均パスワードの長さを増やすことができます。

#### 5.1.2 Password Composition/Complexity

- 全ての文字種類（数字・英大文字・英小文字・記号）の使用を許可する
- パスワード認証のみの場合はアルファベット以外の文字を最低でも１文字含める
- MFA（多要素認証）がある場合はパスワードの複雑性を求めない

#### 5.1.3 Password Expiration

- ユーザーの役割や業務の変更や部署・会社から離れたタイミング等での速やかなパスワードの変更
- 年に一度のパスワードの変更
  - パスワードが複数の人で共有されることも想定している

#### 5.5.3 Ensure password reuse is limited

- 「過去●世代のパスワードの利用を許可しない」のような記述はなし
  - OS毎の説明では値に差がある
- AlmaLinux8では5世代、Debian Linux11では24世代

#### 5.1.6 Limit Failed Login Attempts (Lockout)

- 連続した失敗したログイン試行が5回あった場合は、一時的なアカウントロックアウト（15分以上）をおこなう
- 10回連続した失敗した試行があった場合は、永続的なアカウントロックアウト（ITのリセットが必要）をおこなう

### PCI DSS v4.0

- パスワードの長さは12文字以上とする
- パスワードは変更する頻度に応じて十分に複雑に構成する
  - 最低年に1回の頻度でパスワードを変更する場合、大文字、小文字、数字、特殊文字を含む15文字以上とすること
  - パスワードの変更要件は多要素認証を搭載していないシステムのみに適用する
- 多要素認証を実装する
- 直近4回使用されたパスワードは新しいパスワードとして使用できないようにする
- アカウントのロックアウトにより、連続したアクセス試行を6回以内に制限する
  - ロックアウト時間は最低30分間、またはアドミニストレーターが許可するまでとする

### PCA Hub従来仕様（廃止）

- 12～256文字
- 下記の文字種類を3つ以上組み合わせる必要がある。
  - 半角英字（大文字）
  - 半角英字（小文字）
  - 数字
  - 記号
- 初期値：すべての文字種類を組み合わせる

## パスキーポリシー

| 設定項目 | Keycloak設定名 | 値 |
| -- | -- | -- |
| 認証サービス名 | Relying party entity name | PCA ID |
| 署名アルゴリズム | Signature algorithms | ES256, ES384, ES512, RS256, RS384, RS512 |
| 認証ドメイン | Relying party ID | id.pca.jp（本番環境）<br/> *.id.pca-dev.net（その他環境） |
| 認証証明設定 | [Attestation conveyance preference](https://www.w3.org/TR/webauthn-2/#enum-attestation-convey) | None |
| 認証器プラットフォーム | [Authenticator Attachment](https://www.w3.org/TR/webauthn-2/#enum-attachment) | Platform |
| レジデント鍵（ログインID不要） | [Require resident key](https://www.w3.org/TR/webauthn-2/#enum-residentKeyRequirement) | No |
| 認証器認証  | User verification requirement | Preferred |
| 認証タイムアウト  | Timeout | 無期限 |
| 同一認証器の重複登録不可 | Avoid same authenticator registration | Off |
| サポートする認証器識別子  | Acceptable AAGUIDs | 未指定 |
| 外部オリジン  | Extra Origins | 未指定 |

### パスキーポリシーの参考情報

- [KeycloakのWebAuthn Passwordlessについて](https://qiita.com/i7a7467/items/694fd9a30df1fb87db40)
- [パスキーの概要とKeycloakでの動作確認](https://qiita.com/tksst/items/e723612fe8e99a610609)
- [WebAuthnことはじめ \| メルカリエンジニアリング](https://engineering.mercari.com/blog/entry/2019-06-04-120000/)

## ログインポリシー

- 連続5回の失敗により、アカウントを一時的に30分間ロックアウトする
  - ブルートフォース攻撃（総当たり攻撃）が疑われる高速な（500ms以内の）連続失敗なら、5回を待たずに1分間ロックアウトする
- アカウントロック状態は、どんな状況からでも、30分待つことで自動的に解除する

| 設定項目 | Keycloak設定名 | 値 | [PCA Hub従来仕様](https://pca1980.backlog.com/alias/wiki/851388) |
| -- | -- | -- | -- |
| ロックアウトまでの失敗操作数 | Max login failures | 5回 | 3～10回、初期値：5回 |
| 永久ロックアウト | Permanent lockout | Off | 「解除しない」により適用 |
| 加算するロックアウト時間 | Wait increment | 30分 | |
| 最大ロックアウト時間 | Max wait | 30分 | 5分、10分、30分（初期値）、1時間、1日、解除しない |
| 失敗カウントリセット時間 | Failure reset time | 30分 | |
| ロックアウトさせる連続失敗間隔 | Quick login check milliseconds | 500ms | |
| 連続失敗によるロックアウト時間  | Minimum quick login wait | 1分 |  |

### ログインポリシーの参考情報

- [Red Hat build of Keycloak - 15.3. 総当たり攻撃](https://access.redhat.com/documentation/ja-jp/red_hat_build_of_keycloak/22.0/html/server_administration_guide/password-guess-brute-force-attacks)
