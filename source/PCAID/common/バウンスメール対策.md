---
sidebar_position: 24
---

# 24. バウンスメール対策

## 目的

- メール送信の未達（ハードバウンス）によって、メールサービスが利用停止となる事態を未然に防ぐ
- メールサービスが利用不可になると、PCA ID の 2FA である「メール認証」が機能せず、PCAサービスを提供きなくなるリスクがある
- 特に PCA Hub の場合、PCA ID との統合により、「メール認証」が使えない事態はサービス停止と同じ意味となり許容できない

## 初版（Ver1.0）の仕様

- 「PCAメールサービス」と同じ Amazon SES を利用している
  - 内部的にオレゴンリージョンの SES を有効化しており、すべてのPCAサービスで共用する形となっている
  - 本番環境と開発環境のアカウントは異なるため、SES 環境は分離されている
- 「PCAメールサービス」は、PCA ID での招待や認証利用のほか、各種のアプリ機能においても利用している
  - PCA ID における招待メール、メール認証、etc...
  - PCAクラウド/PCAサブスクにおける管理者通知
  - PCA Hub における給与明細配信、取引明細配信、年末調整連絡、労務管理連絡、etc...
- バウンスメールへの対策は、SESのサプレッションリスト機能によりメールアドレスごとに実施している

### インシデント（2024/09）

- PoC環境において、大量ユーザーのインポート処理テストを実施したが、このときダミーのメールアドレスが使われた
- 存在しないメールアドレス宛てにメールが送信され、開発用 SES において瞬間的に大量のハードバウンスが発生した
- AWSサポートからメール連絡があり、SES 利用について監視対象となったことを伝えられた
- バウンスの原因となったメール送信を停止し、AWSサポートへ再発防止の取り組みを伝えたことで経過観察の状態となった
- １週間程度の経過観察を経て、問題ないと判断された結果、監視対象から除外されて通常利用に戻った

### 考察

- 悪意のある利用者は、管理者権限があれば、通常操作の範囲で同様の結果を引き起こすことができる
- 意図的に SES を利用停止にすることで、すべての利用者に対してサービス提供を止めることができる
- PCA ID でのメール利用が、アプリ機能のメール利用に影響を与える可能性があり、その逆もあり得る
- バウンスメールは送信することで判別できるため、原理的にバウンスメールを 0 にすることはできない
- 現状のバウンスメール対策は、メールアドレスごとに管理されるため、異なるメールアドレスには効果がない

## Ver2.0 要件（対策）

- PCA ID の AWS アカウントの SES を利用する
  - 認証とアプリでメール送信の機能を分離する
  - 可用性を担保するための冗長化構成として、既存 SES をホットスタンバイ利用することを検討する
    - Keycloak 設定により固定化されるので、自動化は困難かもしれない
- 東京リージョンを利用する
  - 既存 SES は、別アカウントでオレゴンリージョンを利用している
  - グレイリスティング（Greylisting）対策にもなる可能性がある
- バウンス率をモニタリングして組織単位でブロックできるようにする
  - 独自に組織単位でサプレッションリストを管理する必要がある
  - 悪意のある利用者がいる組織だけが利用不可となり、他の組織のサービス提供には影響がないようにする
  - メール送信をブロックしたら組織管理者とCBCへ通知する
- アカウントレベルのバウンス率が一定数を超えたら、緊急措置として SES を一時停止させることを検討する
  - [Amazon SES アカウントの E メール送信を自動的に一時停止する \- Amazon Simple Email Service](https://docs.aws.amazon.com/ja_jp/ses/latest/dg/monitoring-sender-reputation-pausing-account.html)
  - [バウンス率、苦情率 \- Amazon Pinpoint](https://docs.aws.amazon.com/ja_jp/pinpoint/latest/userguide/channels-email-deliverability-dashboard-bounce-complaint.html)
  - バウンス率は **5％** 以下に維持する必要がある
  - バウンス率が基準を超えてもレビュー対象となるだけで SES の利用停止とはならない
  - → 緊急措置として SES を一時停止させる条件は慎重に決める（バウンス率 10％ 超？）
    - → **当面は保留** とする

### 組織サプレッションリスト

- SES からの「バウンス」イベントを DynamoDB のサプレッションリストに保存する
  - あらかじめEメールには organization_id を紐付けておく
- organization_id と mesasageId の組み合わせで、サプレッションレコードを管理する
- バウンス件数が一定数を超えた組織からのメール送信をブロックする
  - organization_id ごとに、**直近24時間** の件数をカウントする
  - 1000人の組織を想定すると、バウンス率 5％ を下回るには、**50件未満** が条件となる
  - ブロックされた組織は自動回復に **24時間** 待つ必要があるが、待てなければPCAにブロック解除を依頼することになる

```json
{
  "organization_id": "xxxx-xxx-xxx-xxxx",
  "mesasageId": "abdc....xxx", 
  "sesEvent": {
    "eventType": "Bounce",
    "mail": ...,
    "bounce": ...
    "..."
  }
}
```

[Amazon が Amazon SES に発行するイベントデータの内容 SNS \- Amazon Simple Email Service](https://docs.aws.amazon.com/ja_jp/ses/latest/dg/event-publishing-retrieving-sns-contents.html)
