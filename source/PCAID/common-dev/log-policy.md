---
sidebar_position: 52
---

# 52. ログ記録方針

## ログ種類

### サービスごとに記録するログ

- Terraformによるログ設定の対象とする

| 種類 | 保存先 | 保持期間<br/>（開発） | 目的 | 利用者 | 形式 |
| --- | --- | --- | --- | --- | --- |
| Cloudfront アクセスログ | S3 | 3ヶ月 | アクセス調査 | CBC<br/>開発 | AWS標準 |
| WAF ログ | S3 | 3ヶ月 | 攻撃調査 | CBC<br/>開発 | AWS標準 |
| API Gateway アクセスログ | CloudWatch | 3ヶ月 | アクセス調査 | CBC<br/>開発 | AWS標準 |
| Lambda アクセスログ | CloudWatch | 3ヶ月 | アクセス調査<br/>実行監視 | CBC<br/>開発 | AWS標準<br/>拡張モニタリング |
| Lambda アプリケーションログ | CloudWatch <br/> → S3+Athena | 3ヶ月<br/>無期限 | アクセス調査<br/>利用状況分析 | 全社 | PCA共通 |
| Lambda 操作ログ（監査ログ） | CloudWatch <br/> → S3 | 3ヶ月 <br/> 25ヶ月 | 操作履歴の確認<br/>ユーザー監査 | ユーザー | PCA ID独自 |
| ALB アクセスログ | S3 | 3ヶ月 | アクセス調査 | CBC<br/>開発 | AWS標準 |
| Keycloak アクセスログ <br/>（ECS コンテナログ） | CloudWatch <br/> → S3+Athena | 3ヶ月<br/>無期限 | アクセス調査 | CBC<br/>開発 | Keycloak標準 <br/>+PCA ID拡張 <br/>Container Insights |
| Keycloak イベントログ<br/>（一部を操作ログとして利用） | Keycloak DB <br/> CloudWatch <br/> → S3 | 3ヶ月 <br/> 3ヶ月 <br/> 25ヶ月 | 操作履歴の確認<br/>ユーザー監査 | ユーザー | PCA ID独自 |
| Auroraログ | CloudWatch | 3ヶ月 | アクセス調査<br/>DB調査 | CBC<br/>開発 | AWS標準<br/>拡張モニタリング<br/>Performance Insights |
| S3サーバーアクセスログ | S3 | 3ヶ月 | アクセス調査 | CBC<br/>開発 | AWS標準 |
| VPCフローログ | S3 | 3ヶ月 | NW通信調査 | CBC<br/>開発 | AWS標準 |

### サービスを横断して記録するログ

- Terraformによるログ設定の対象外とする
- 必要に応じて手動で有効化することを想定する

| 種類 | 保存先 | 保持期間 <br/>（開発） | 目的 | 利用者 | 形式 |
| --- | --- | --- | --- | --- | --- |
| CloudTrail イベントログ | S3 | 3ヶ月 | AWS API利用調査 | CBC<br/>開発 | 管理イベント<br/>データイベント<br/> Insights イベント |
| GuardDuty 検出結果ログ | S3 | 本部方針に従う | 脅威検出 | CBC | AWS標準 |
| Config? | S3 | ？ | 設定調査 | CBC | AWS標準 |
| DNSクエリログ？ | CloudWatch | 3ヶ月 | ドメイン問合せ調査 | CBC<br/>開発 | AWS標準 |

## ログの取り扱い方針

### 調査を目的とするログ

- AWS標準ログを使い、基本的に CloudWatch や S3 との統合機能を利用して記録する
  - どちらも選択できる場合、特別な要件がなければ S3 を優先する
  - CloudWatch でしか達成できない要件があれば、CloudWatch を選択する
- 開発環境における保持期間は比較的短期として、調査や監視に過不足のない期間とする
  - 本番環境においては、コストが問題にならない限りは安全性を優先して「無期限」とする

### 調査の他に分析も目的とするログ

- AWS標準を含む任意形式のログを使い、最終的な保存場所を S3 としたパイプラインを構成する
  - 一般的なケースとして、CloudWatch への記録を経由して、S3 へ保存する方式がある（コストがかかる）
- S3 上のログデータに対して Athena のクエリーによる分析をできるようにする
- 開発環境における保持期間は比較的長期として、調査や監視に過不足のない期間とする
  - 本番環境においては、安全性を考慮して常に「無期限」とする
- ログ日時はUTCで記録する
  - ログ日時の表示で理解しやすいタイムゾーン（例：JST）に変換する

## アプリログ

- PCA共通のログフォーマットを利用する
  - [アプリログ仕様](./app-log-spec.md)
- PCAによる分析の対象とする
  - ユーザーに提供するデータではない
- 将来的に、PCAサービスを横断したログ分析基盤（＝利用状況分析）を構築していく
- 記録の対象外とするログデータは以下のとおりとし、マスク処理として `[redacted]` に置き換える
  - パスワードやクレジットカード情報（無いはず）などの機密情報
  - アクセストークン､リフレッシュトークン
  - ログインクッキー
  - システムの重要な設定情報（シークレットキーや秘密鍵）

## 操作ログ（監査ログ）

- PCA ID 独自のログフォーマットを利用する
- 管理者ユーザー向けにCSV出力機能として提供する
- [操作ログの種類と詳細](/docs/common/操作ログの種類と詳細.md)
