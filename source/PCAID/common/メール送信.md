---
sidebar_position: 23
---

# 23. メール送信

Keycloakメール機能をカスタマイズして実装する

## メール利用時の基本方針

- 基本的にHTMLメールを利用するが、表示互換性を重視して、テキストメールでも正しく表示させる
- 等幅フォントを想定する
- PCAからのメールと認識できるように、見出しは先頭に【PCAサービス】を付加し、フッターには会社の身元を記載する
- ユーザーの宛先に取り違えがないように、メール本文の先頭に氏名を明記する
- PCA Hub のメール本文を踏襲する
  - <https://pca1980.backlog.com/alias/wiki/1310675>

## 送信メール一覧

| ケース | PCA ID |  PCA Hub <br/>（参考） | 備考 |
| -- | :--: | :--: | -- |
| 【依頼】招待（管理者）<br/> `VERIFY_EMAIL` <br/> `UPDATE_PASSWORD` <br/> `CONFIGURE_RECOVERY_AUTHN_CODES` | ◯ | ◯→✕ | ・基本的にユーザーの作成と同時に招待する  <br/> 　・後から招待メールを送信することもできる <br/> ・作成ユーザーが新規アカウントならこの「招待」を使用する <br/>・作成ユーザーが他組織に所属する既存アカウントなら「メールアドレス検証」を使用する |
| 【通知】招待完了 |  | ◯→✕ | ・PCA ID では「パスワード変更」や「メールアドレス検証完了」の通知で知らせる <br/>・PCA Hub では初回パスワード設定の完了時に通知する |
| 【依頼】ログイン認証コード発行 | ◯ | ◯→✕ | 二段階認証（メール認証）のときに送信する |
| 【通知】ログインエラー | ◯ | | |
| 【要求】パスワード変更（リセット） <br/> `UPDATE_PASSWORD` | ◯ | ◯→✕ | ・PCA IDでは以下のケースでメール経由の操作となる <br/> 　・管理者による強制リセット <br/> 　・本人がパスワードを忘れた <br/>　（本人による通常の変更にはメールを使わない） <br/>・PCA Hubでは管理者・本人ともメール経由の操作となる |
| 【通知】パスワード変更 | ◯ | ◯→✕ | パスワードの変更を本人にメールで通知する |
| 【要求】メールアドレス変更 <br/> `UPDATE_EMAIL` | ◯ | ◯→✕ | PCA IDは以下のケースで使用する（PCA Hubでは使わない） <br/>・本人がアドレスを変更するとき |
| 【通知】メールアドレス変更完了 | ◯ | ◯→✕ | アドレス変更を本人にメールで通知する <br/> ※Keycloakイベント経由のカスタマイズ |
| 【要求】メールアドレス検証 <br/> `VERIFY_EMAIL` | ◯ | | 以下のケースで使用する <br/>・管理者が新しい組織に既存アカウントを招待するとき <br/>・管理者がユーザーのアドレスを変更するとき <br/> PCA Hubは以下のケースで使用する（PCA IDとは異なる） <br/>・本人がアドレスを変更するとき |
| 【通知】メールアドレス検証完了 | ◯ | | 自身のアドレス利用が検証できたことを知らせる <br/> ※Keycloakイベント経由のカスタマイズ |
| 【通知】メールアドレス変更（管理者） | - | ◯→✕ | 廃止とする（変更通知は管理者と本人を区別しない） |
| 【通知】ライセンス付与（管理者） | - | ◯ | PCA Hub から通知する |
| 【通知】ライセンス解除（管理者） | - | ◯ | PCA Hub から通知する |

## 文頭の宛名

- ユーザー名 ＋（半角スペース）＋「様」
  - 例：山田 太郎 様
- PCAアカウント属性項目の入力状態に応じて、以下の順番で表示するユーザー名を切り替える
  - [PCAアカウント](./PCAアカウント.md)

1. 「姓」＋（半角スペース）＋「名」
    - 姓と名のいずれかの値が入力済みの場合
    - 例１：佐藤 二郎
    - 例２：佐藤
2. 「表示名」を利用する
    - 表示名が入力済みの場合
3. `ご利用ユーザー` 固定とする
    - 姓と名、表示名のいずれも未入力の場合

- 現時点の仕様では、「姓」や「表示名」が必須のため、3 になるケースはない
- 将来は、本人による簡便なアカウント登録を可能にするため、招待フロー時点では名前項目を必須としない可能性がある

## 有効期限

- 管理者による招待メールの有効期限は **1週間** とする
- 管理者によるリクエストは **30分** とする
- 本人によるリクエストは **10分** とする
- 管理者によるリクエストを本人が再送信することはできない
  - 従来のPCA Hub では再送信が可能だったが、セキュリティのため廃止する
  - 本人による再送信を認めることは、実質的には無期限と同じ

## 共通フッター

```text
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
PCAサービス利用組織：{組織表示名}

このメールは送信専用メールアドレスからお送りしています。
ご返信いただいてもお答えできませんので、あらかじめご了承ください。
　運営：ピー・シー・エー株式会社
　　　　東京都千代田区富士見1-2-21 PCAビル
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

- このWebページでは崩れて見える（横線が短い）が内容の間違いではない

## 招待メール

```text
【PCAサービス】{組織表示名} からのアカウント設定リクエスト
－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－
山田 太郎 様

{組織表示名} より、PCAアカウントの設定リクエストを承りました。
このリクエストメールにお心当たりがなければ、メッセージは無視してください。

以下のリンクをクリックしてアカウント設定を行ってください。

[PCAアカウントを設定します](https://id.pca.jp/...)

このリンクの有効期限は 1週間 です。
期限切れとなった場合は、{組織表示名} の管理者に再送信をご依頼ください。
```

- 有効期限の表示は「7日間」でも構わない

## パスワード変更通知

```text
【PCAサービス】パスワード変更のお知らせ
－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－
山田 太郎 様

あなたが利用するPCAアカウントのパスワードが変更されました。

日時：2023年 7月 10日（月曜日）10:03:45
IPアドレス：127.0.0.1
ブラウザー：Chrome(Windows)

お心当たりがなければ、大変お手数ですが、{組織表示名} の管理者にご連絡ください。
```

- 日時は日本時間とする

## ログイン認証コードのお知らせ

```text
【PCAサービス】2段階認証コード：065401
－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－
山田 太郎 様

PCAアカウントの2段階認証に必要な認証コードをお知らせいたします。

2段階認証コード：**065401**

この2段階認証コードの有効期限は 10分 です。
このメールは 12:34 に送信しています。
認証コードを再送信すると、この認証コードは無効になります。
```

## ログインエラー通知

```text
【PCAサービス】ログインエラーのお知らせ
－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－
山田 太郎 様

あなたが利用するPCAアカウントにおいて、ログインエラーが発生しました。

日時：2023年 7月 10日（月曜日）10:03:45
IPアドレス：127.0.0.1
PCAサービス：PCA Hub

お心当たりがなければ、安全のためパスワードを変更するか、大変お手数ですが、{組織表示名} の管理者にご連絡ください。
```

- 日時は日本時間とする

## パスワード変更・リセット

```text
【PCAサービス】パスワード再設定リクエスト
－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－
山田 太郎 様

PCAアカウントのパスワード再設定リクエストを承りました。
このリクエストメールにお心当たりがなければ、メッセージは無視してください。

以下のリンクをクリックしてパスワードの再設定を行ってください。

[PCAアカウントのパスワードを再設定します](https://id.pca.jp/...)

このリンクの有効期限は 30分 です。
```

## メールアドレス変更

```text
【PCAサービス】メールアドレス変更リクエスト
－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－
山田 太郎 様

PCAアカウントのメールアドレス変更リクエストを承りました。
このリクエストメールにお心当たりがなければ、メッセージは無視してください。

変更前のメールアドレス：hoge@gmail.com
変更後のメールアドレス：fuga@gmail.com

ご本人様が利用するメールアドレスであることを確認するため、以下のリンクをクリックして変更を行ってください。

[PCAアカウントのメールアドレスを変更します](https://id.pca.jp/…)

このリンクの有効期限は 10分 です。
期限切れとなった場合は、メールアドレスの変更手順をやり直してください。
```

## メールアドレス変更通知

```text
【PCAサービス】メールアドレス変更のお知らせ
－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－
山田 太郎 様

PCAアカウントのメールアドレスが変更されました。

日時：2023年 7月 10日（月曜日）10:03:45
IPアドレス：127.0.0.1
ブラウザー：Chrome(Windows)
```

## メールアドレス検証

```text
【PCAサービス】メールアドレス確認リクエスト
－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－
山田 太郎 様

PCAアカウントのメールアドレス確認リクエストを承りました。
このリクエストメールにお心当たりがなければ、メッセージは無視してください。

メールアドレス：hoge@gmail.com

ご本人様が利用するメールアドレスであることを確認するため、以下のリンクをクリックしてください。

[PCAアカウントのメールアドレスを確認します](https://id.pca.jp/…)

このリンクの有効期限は 30分 です。
期限切れとなった場合は、ログイン画面から確認メールの再送信が可能です。
詳しくは「メールでメールアドレス確認リクエストが届いたら」をご確認ください。
```

- [メールでメールアドレス確認リクエストが届いたら](https://pca.jp/area_support/manual/pcaid/03_client/client_08.html)

## メールアドレス検証通知

```text
【PCAサービス】メールアドレス確認完了のお知らせ
－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－－
山田 太郎 様

PCAアカウントのメールアドレス確認が完了しました。

日時：2023年 7月 10日（月曜日）10:03:45
IPアドレス：127.0.0.1
ブラウザー：Chrome(Windows)
```
