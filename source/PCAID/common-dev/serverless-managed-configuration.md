---
sidebar_position: 4
---

# 4. サーバーレス&マネージド構成

## 冗長化と制限（可用性の担保）

### CloudFront

- [WAF ルール](./waf-rules.md)
- TLS v1.2 2021

### API Gateway

- スロットリング
  - DoS対策
    - DynamoDBキャパシティーユニットを考慮する
      - 現在はすべて「オンデマンド」としているので、急激な負荷上昇のみ注意する
  - ステージに対して設定する
  - 管理API（api/admin/v1）
    - レート：**10,000 リクエスト/秒**
    - バースト：**5,000 リクエスト**
  - 組織API（api/orgs/v1）
    - レート：**500 リクエスト/秒**
    - バースト：**100 リクエスト**
  - アカウントAPI（api/account/v1）
    - レート：**1000 リクエスト/秒**
    - バースト：**300 リクエスト**
  - アプリAPI（api/apps/v1）
    - レート：**1000 リクエスト/秒**
    - バースト：**300 リクエスト**
  - 組織作成API（api/orgs-new/v1）
    - レート：**500 リクエスト/秒**
    - バースト：**100 リクエスト**

### Lambda

- メモリ
  - **256 MB**
  - AWS Compute Optimizer の推奨によって調整する
    - オーソライザー
    - イベント通知系
- エフェメラルストレージ
  - **512 MB**
- タイムアウト
  - **30 秒**
  - 非同期ジョブはユースケースに応じて長くする
- プロビジョニングされた同時実行
  - コールドスタート対策
    - Auroraに接続する関数のみ対象とする
      - ユーザー一覧の取得（クエリー）
      - サービス利用状況の取得
  - プロビジョニングされた同時実行（関数レベルの最小実行環境数）：**3**
- 同時実行
  - RDSへの最大接続数を超えないように制限する
    - Auroraに接続する関数のみ対象とする
      - ユーザー一覧の取得（クエリー）
        - 同時実行の予約（関数レベルの最大実行環境数）：**100**
      - サービス利用状況の取得
        - 同時実行の予約（関数レベルの最大実行環境数）：**30**
      - サービス契約情報の取得（別アカウントRDSへのクエリー）
        - 同時実行の予約（関数レベルの最大実行環境数）：**20**
          - アプリAPIに大きく振り分け **10** とし、残りを小さく配分する
    - 同時実行の予約：**合計 200 以内**に個別指定
  - メール送信の上限を超えないように制限する
    - SESで大量にメール送信する関数のみ対象とする
      - ユーザーインポート
    - 同時実行の予約（関数レベルの最大実行環境数）：**30**
- 拡張モニタリング
  - **有効にする**
- X-Ray
  - **一部のみ有効にする**
  - イベント通知系
    - eventHookEnqueue
    - eventHookPublish
    - eventDelivery

### DynamoDB

- キャパシティーユニット
  - すべて「オンデマンド」を利用する
    - [Amazon DynamoDB がオンデマンドスループットとグローバルテーブルの価格を引き下げ \- AWS](https://aws.amazon.com/jp/about-aws/whats-new/2024/11/amazon-dynamo-db-reduces-prices-on-demand-throughput-global-tables/)
    - [初期スループットとスケーリングのプロパティ](https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/on-demand-capacity-mode.html#on-demand-capacity-mode-initial)
- 読み込みキャパシティーユニット（1RCU=4KB/s）
  - 初期スループット **12000 RCU**
    - 項目平均 4 KB
    - 12000項目/秒
    - 強力な整合性
- 書き込みキャパシティーユニット（1WCU=1KB/s）
  - 初期スループット **4000 RCU**
    - 項目平均 4 KB
    - 1000項目/秒
- 削除保護
  - **ON**

### ECS

- 起動タイプ
  - Fargate 1.4.0
- 本番用アカウント（CBC）の環境
  - ALB
    - **3** ターゲット固定（マルチAZ）
  - サービス
    - Auto Scaling
      - 最小タスク：**3**
      - 最大タスク：**30**
      - メモリー **50％**
      - CPU **30％**
      - スケールイン：**ON**
  - タスク
    - Keycloak コンテナ
      - **2 vCPU**
      - **8 GB RAM**
- 開発用アカウントの環境
  - ALB
    - **2** ターゲット固定（マルチAZ）
  - サービス
    - Auto Scaling
      - 最小タスク：**2**
      - 最大タスク：**20**
      - メモリー **50％**
      - CPU **30％**
      - スケールイン：**ON**
  - タスク
    - Keycloak コンテナ
      - **1 vCPU**
      - **2 GB RAM**
- コンテナインサイト
  - **有効にする**
- GuardDuty エージェント
  - **有効にする**（CBCによる手動管理）
- AZ リバランシング
  - **有効にする**
- ALB ルーティング
  - Keycloak ヘルスチェック
    - ルール：`/health/ready`
    - リスナー：**https:443**
    - 転送先：**http:9000**
  - Keycloak 本体
    - ルール：デフォルト
    - リスナー：**https:443**
    - 転送先：**http:8080**
- Datadog
  - Keycloak のログやメトリクスを転送する

### ECR

- 拡張スキャン（インスペクター）
  - プッシュ時スキャン
  - 連続スキャン
- 開発環境においては `yamory` サービスも併用する

### Aurora

- 本番用アカウント（CBC）の環境
  - マルチAZ
    - 可用性を優先する
  - **2** インスタンス固定
  - **db.r7g.2xlarge**（Ver2.0 未満は db.r6i.2xlarge）
    - **8 vCPU**
    - **64 GB RAM**
- 開発用アカウントの環境
  - シングルAZ
    - コストを優先する
  - **1** インスタンス固定
  - **db.t4g.medium**（Ver2.0 未満は db.t3.medium）
    - **2 vCPU**
    - **4 GB RAM**
- パフォーマンスインサイト
  - 保持期間：~~3ヶ月~~ → データベースインサイトへの移行により7日間のみ
  - 拡張モニタリング：**有効**
- CloudWatch データベースインサイト
  - 本番環境、PoC環境
    - 保持期間（アドバンスト）：15ヶ月
  - その他の環境
    - 保持期間（ベーシック）：7日間

## 暗号化

| AWSサービス | 暗号化 | 方式 | 単位 | 備考 |
| --- | :---: | --- | --- | --- |
| Aurora | ◯ | Aurora による管理 | クラスター | |
| DynamoDB | ◯ | DynamoDB による管理 | テーブル | |
| S3 | ◯ | S3キー（SSE-S3） | バケット | |
| SQS | ◯ | SQSキー（SSE-SQS） | キュー | |
| SNS | ◯ | SNSキー（SSE-SNS） | トピック | デフォルトは無効 |
| Fargate | ◯ | Fargateによる管理 | ECSサービス | |
