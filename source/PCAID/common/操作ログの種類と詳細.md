---
sidebar_position: 31
---

# 31. 操作ログの種類と詳細

## 全般

- [管理コンソール - サービス利用状況](/docs/apps/orgs/orgs-service-usages.md)
  - すべてのデータ種類を対象とした操作ログはCSV出力のみ可能（画面表示できない）
    - CSV出力は、直近の２年間を出力対象とする
  - 組織内のすべてのユーザーを対象として、認証ログ（データ種類が「認証」のログ）の画面表示が可能
    - 画面表示は、直近の１週間（7日間）を表示対象とする
- [アカウント設定 - サービス利用状況](/docs/apps/account/account-service-usages.md)
  - 自分自身を対象として、認証とセキュリティに関するログの画面表示が可能
    - データ種類が「ユーザー」の、自分自身で操作したセキュリティ関連のログ
    - データ種類が「認証」の、自分自身で操作したすべてのログ
  - 直近の１週間（7日間）を表示対象とする

## データフォーマット

- データ形式：CSV（カンマ区切り）
- ファイル名：`操作ログ_{yy}-{mm}-{dd}_{hh}-{mm}-{ss}.csv`
  - 例：操作ログ_2024-06-11_18-08-30.csv
- 文字エンコーディング：UTF-8 (BOM付き)
- 改行文字：CRLF または LF
  - .csv ファイルのExcelへの関連付けで正常に開けること
- 行フォーマット
  - １行目：ヘッダー行
    - 項目一覧は固定とする
    - バージョン管理はしない
  - ２行目以降：データ行
    - 文字列データはダブルクォーテーション（"）で囲う
    - Excelで正しく開けるように配慮する

### データ項目

| No. | 項目名 | 説明 | 必須 | 例 |
| --: | --- | --- | :---: | --- |
| 1 | ログ種類 | ログの種類 | ◯ | 重要 → **重要な操作**が正常に完了したとき <br/> 情報 → 操作が正常に完了したとき <br/> 警告 → 操作が正常に失敗したとき <br/> エラー → 操作が意図せず失敗したとき  |
| 2 | 日時 | `yyyy/mm/dd hh:mm:ss` <br/> ※保存は世界時間（UTC） | ◯ | 2024/06/04 09:07:21 <br/> ※出力は日本時間（JST） |
| 3 | アプリケーション名 | OIDC/OAuthクライアント名 | ◯ | PCA Hub, PCA ID アカウント設定 |
| 4 | IPアドレス | IPアドレス(IPv4) <br/> ※ユーザー利用IPは必須 | ※ | 12.34.56.78 <br/> ※PCA IDやHubの利用IPは非表示 |
| 5 | 組織ID | 実行対象の組織ID | ◯ | xxxx-xxxx-xxxx |
| 6 | 組織名 | 実行対象の組織名 | ◯ | tenant1, pca-dev |
| 7 | アカウントID | 実行ユーザー <br/> ※特定可能なときは必須 | ※  | xxxx-xxxx-xxxx |
| 8 | ユーザー名 | 実行ユーザー <br/> ※特定可能なときは必須 | ※ | 総務部_山田太郎 |
| 9 | ログイン名 | 実行ユーザー <br/> またはバックグラウンドジョブ | ◯ | yamada <br/> (System) 　※システム系の操作 |
| 10 | データ種類 | 対象データの種類 | ◯ | 組織、ユーザー、認証 |
| 11 | 操作 | 操作の種類 | ◯ | 作成、更新、ログイン、パスワードの変更 |
| 12 | 内容 | 対象データと操作内容 | ◯ | ユーザー[katou]を作成 |
| 13 | 詳細 | 操作内容の詳細（JSON等）<br/> またはジョブID <br/> ※存在する場合のみ |  | { "login_name":"katou", "preferred_username": "加藤" } <br/> {"auth_method":"openid-connect", ... ,"username":"[yamada@example.com](mailto:yamada@example.com)"} |
| 14 | トレースID | W3C形式のトレースID <br/> ※メール送信以外は必須 | ※ | xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxx |
| 15 | エラー情報 | エラーコードやメッセージ <br/> ※エラー時のみ | | UserNotFound, InvalidArgument <br/> アカウントID 'xxxx-xxxx-xxxx' のユーザーは見つかりませんでした。 |

## 操作ログの種類

### 組織操作

- データ種類は「組織」固定とする
- 操作ログのCSV出力には、組織管理者の権限を必要とする
- 操作が意図せず失敗すると、ログ種類が「エラー」になる

| ログ種類 | 操作 | 内容 | 詳細（JSON等） |
| :---: | --- | --- | --- |
| 重要 | [作成](/docs/api/organizations/POST%20組織作成.md) | 組織[`@organization_name`]を作成 | 組織表示名<br/>サービス区画<br/>サービスロール |
| | [更新](/docs/api/organizations/PUT%20組織更新.md) | 組織[`@organization_name`]を更新 | 組織表示名<br/>顧客ID |
| | [画像の更新](/docs/api/organizations/images/logo/PUT%20組織画像アップロード.md) | 組織[`@organization_name`]の画像を更新 | |
| 重要 | [組織名の変更](/docs/api/organizations/rename/PUT%20組織名変更.md) | 組織[`@organization_name`]の組織名を変更 | 新しい組織名 |
| 重要 | [サービス区画の追加](/docs/api/organizations/service_partitions/POST%20組織内サービス区画追加.md) | 組織[`@organization_name`]にサービス区画を追加 | サービス区画 |
| 重要 | [サービス区画の削除](/docs/api/organizations/service_partitions/remove/POST%20組織内サービス区画削除.md) | 組織[`@organization_name`]からサービス区画を削除 | サービス区画 |
| 重要 | 組織統合リクエストの送信 <br/> ※統合元組織 | 組織[`@organization_name`]から組織[`@organization_name`]への統合リクエストを送信 | 実行ユーザー（ログイン名）<br/> リクエスト状態 <br/> リクエスト期限 |
| | 組織統合リクエストの取消 <br/> ※統合元組織 | 組織[`@organization_name`]から組織[`@organization_name`]への統合リクエストを取り消し | 実行ユーザー（ログイン名）<br/> リクエスト状態 <br/> リクエスト期限 |
| 重要 | 組織統合リクエストの確認 <br/> ※統合元組織 | 組織[`@organization_name`]から組織[`@organization_name`]への統合リクエストを確認 | 実行ユーザー（ログイン名）<br/> リクエスト状態 <br/> リクエスト期限 |
| 重要 | 組織統合リクエストの承諾 <br/> ※統合先組織 | 組織[`@organization_name`]から組織[`@organization_name`]への統合リクエストを承諾 | 実行ユーザー（ログイン名）<br/> リクエスト状態 <br/> リクエスト期限 |
| 重要 | 組織統合リクエストの却下 <br/> ※統合先組織 | 組織[`@organization_name`]から組織[`@organization_name`]への統合リクエストを却下 | 実行ユーザー（ログイン名）<br/> リクエスト状態 <br/> リクエスト期限 |
| | 組織統合の開始 <br/> ※統合先組織 | 組織[`@organization_name`]から組織[`@organization_name`]への統合を開始 |  |
| 重要 | 組織統合の完了 <br/> ※統合先組織 | 組織[`@organization_name`]から組織[`@organization_name`]への統合を完了 |  |

### ユーザー操作

- データ種類は「ユーザー」固定とする
- 操作ログのCSV出力には、組織管理者の権限を必要とする
- 操作が意図せず失敗すると、ログ種類が「エラー」になる

| ログ種類 | 操作 | 内容 | 詳細（JSON等） |
| :---: | --- | --- | --- |
| | [作成](/docs/api/users/POST%20ユーザー作成.md) | ユーザー[@login_name]を作成 | メールアドレス<br/>表示名<br/>姓名とカナ |
| | [更新](/docs/api/users/account_id/PUT%20ユーザー更新.md) | ユーザー[@login_name]を更新 | ログイン名<br/>メールアドレス<br/>表示名<br/>姓名とカナ |
| | [削除](/docs/api/users/account_id/remove/POST%20ユーザー削除.md) | ユーザー[@login_name]を削除 | |
| 重要 | [無効化](/docs/api/users/account_id/lifecycle/suspend/POST%20ユーザー無効化.md) | ユーザー[@login_name]を無効化 | |
| 重要 | [有効化](/docs/api/users/account_id/lifecycle/unsuspend/POST%20ユーザー無効化解除.md) | ユーザー[@login_name]を有効化 | |
| | [画像の更新](/docs/api/users/account_id/images/profile/POST%20プロフィール画像アップロード.md) | ユーザー[@login_name]の画像を更新 | |
| 重要 | [サービス区画の追加](/docs/api/users/account_id/service_partitions/POST%20ユーザーへのサービス区画追加.md) | ユーザー[@login_name]にサービス区画を追加 | サービス区画 |
| 重要 | [サービス区画の削除](/docs/api/users/account_id/service_partitions/remove/POST%20ユーザーからのサービス区画削除.md) | ユーザー[@login_name]からサービス区画を削除 | サービス区画 |
| | [ロールの割当](/docs/api/users/account_id/service_roles/POST%20ユーザーロールの割り当て.md) | ユーザー[@login_name]にロールを割当 | サービスロール |
| | [ロールの解除](/docs/api/users/account_id/service_roles/unassign/POST%20ユーザーロールの割り当て解除.md) | ユーザー[@login_name]からロールを解除 | サービスロール |
| | [インポート](/docs/api/users/import/POST%20ユーザーインポート非同期.md) | ユーザーインポートを実行 | ファイル名 |
| | [エクスポート](/docs/api/users/export/POST%20ユーザーエクスポート.md) | ユーザーエクスポートを実行 | ファイル名 |
| | バウンス確認 | バウンスメールアドレスを確認 | |
| 重要 | 権限の付与 | ユーザー[@login_name]に権限を付与 | 権限一覧 |
| | 権限の取消 | ユーザー[@login_name]の権限を取り消し | 権限一覧 |
| | セッションのリセット | ユーザー[@login_name]のセッションをリセット | |
| | ユーザー情報の同期 | ユーザー[@login_name]の情報を同期 | ログイン名<br/>メールアドレス<br/>表示名<br/>姓名とカナ |

### ユーザー操作（Kyecloak標準機能）

- データ種類は「ユーザー」固定とする
- 自分以外を操作対象とする操作ログの出力には、組織管理者の権限を必要とする
- CSV出力においては、すべての操作ログを対象とする
  - Keycloak仕様により、パスキー削除が記録されないため、操作ログを出力できない
  - → PCA ID Ver2.0（Keycloak v26）ではパスキー削除をCSV記録できるようになった（イベントには記録されない）
- 画面表示においては、メール送信以外の操作ログを対象とする
  - 技術的な要因により、メール送信の操作ログを画面表示することが難しい
  - 下記の表において、管理者向けの欄が ◯ の操作を対象とする
- 操作内容に「自身の」が含まれる操作ログは、一般ユーザーであっても、自分自身に限定して画面表示できる
  - 操作ログ項目の「アカウントID」によって自身のログを絞り込む
  - 下記の表において、一般向けの欄が ◯ の操作を対象とする
- 操作が意図せず失敗すると、ログ種類が「エラー」になる

| 管理者向け | 一般向け | ログ種類 | 操作 | 内容 | 詳細（JSON等） |
| :---: | :---: | :---: | --- | --- | --- |
| ◯ | ◯ | 重要 | パスワードの変更 | 自身のパスワードを変更 | |
| | | | パスワード変更通知メールの送信 | パスワード変更通知メールを送信（自動） | メールアドレス |
| ~~◯~~ | | 重要 | パスワードのリセット | ユーザー[@login_name]のパスワードをリセット | |
| | | | パスワードリセットメールの送信 | ユーザー[@login_name]へパスワードのリセットメールを送信 | メールアドレス |
| ◯ | ◯ | 重要 | メールアドレスの変更 | 自身のメールアドレスを変更 | 新しいメールアドレス |
| | | | メールアドレス変更通知メールの送信 | メールアドレス変更通知メールを送信（自動） | 変更前のメールアドレス |
| ~~◯~~ | | 重要 | メールアドレスの変更 | ユーザー[@login_name]のメールアドレスを変更 | 新しいメールアドレス |
| | | | メールアドレス変更メールの送信 | ユーザー[@login_name]へメールアドレスの変更メールを送信 | 新しいメールアドレス |
| ◯ | ◯ | 重要 | バックアップコードの発行 | 自身のバックアップコードを発行 | |
| | | 重要 | バックアップコードのリセット | ユーザー[@login_name]のバックアップコードをリセット | |
| ◯ | ◯ | 重要 | パスキーの登録 | 自身のパスキーを登録 | パスキー名 |
| ◯ |  | 重要 | パスキーの削除 | 自身のパスキーを削除 | パスキー名 |
| | | | 招待メールの送信 | ユーザー[@login_name]へ招待メールを送信 | メールアドレス |
| | | | メールアドレス確認メールの送信 | ユーザー[@login_name]へメールアドレスの確認メールを送信 | メールアドレス |
| | | | メールアドレス確認通知メールの送信 | メールアドレス確認通知メールを送信（自動） | メールアドレス |

### 認証操作（Kyecloak標準機能）

- データ種類は「認証」固定とする
- 操作ログのCSV出力には、組織管理者の権限を必要とする
- 一般ユーザーであっても、自分自身の認証操作に限定して画面表示できる
  - 操作ログ項目の「アカウントID」によって自身のログを絞り込む
- 操作が意図せず失敗すると、ログ種類が「エラー」になる

| ログ種類 |  操作 | 内容 | 詳細（JSON等） |
| :---: | --- | --- | --- |
| 情報 |  ログイン | ログインに成功 | サービス名 |
| 警告 |  ログイン失敗 | ログインに失敗 | サービス名 |
| |  ログアウト | ログアウトを実行 | サービス名 |
| | セッションの更新 | ユーザーセッションを自動更新 | サービス名 |

## 参考情報

- [PCA Hub 監査ログ項目](https://pca1980.backlog.com/alias/wiki/867610)
